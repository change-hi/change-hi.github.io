<!DOCTYPE html>
<html lang="en">
<head>
  <title> Change-HI/EDU | 6. Deep learning CPU vs GPU </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">

  <link rel="stylesheet" href="/css/themes/spacelab/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <link href="/css/fontawesome/css/fontawesome.css" rel="stylesheet">
  <link href="/css/fontawesome/css/brands.css" rel="stylesheet">
  <link href="/css/fontawesome/css/solid.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/anchor-js/anchor.min.js"></script>

  

  <!-- Load JQuery, then use it to attach the class 'active' to navbar item currently displayed. -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script>
    $(window).on('load', function () {
      $('.nav-item').find('a[href="' + location.pathname + '"]').addClass('active');
    });
  </script>

</head>
<body>

<div class="navbar navbar-expand-lg fixed-top navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="/index.html"> Change-HI/EDU </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav">
        
        <li class="nav-item"><a class="nav-link" href="/modules/">Modules</a></li>
        
        <li class="nav-item"><a class="nav-link" href="/outcomes/">Outcomes</a></li>
        
        
        <li class="nav-item"><a class="nav-link" href="/readings/">Readings</a></li>
        
        
        <li class="nav-item"><a class="nav-link" href="/experiences/">Experiences</a></li>
        
        
        <li class="nav-item"><a class="nav-link" href="/assessments/">Assessments</a></li>
        
        
      </ul>
    </div>
  </div>
</div>

<!-- Internal fragment for displaying the breadcrumb bar -->
<div class="breadcrumb-background" style="padding-top: 1em; padding-bottom: .01em">
  <div class="container">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item"><a href="/modules">Modules</a></li>
        <li class="breadcrumb-item"><a href="/modules/hpc">High Performance Computing</a></li>
        <li class="breadcrumb-item active">6. Deep learning CPU vs GPU</li>
      </ol>
    </nav>
  </div>
</div>


<div class="container">
  <h1 id="6-deep-learning-cpu-vs-gpu">6. Deep learning CPU vs GPU</h1>

<div class="alert alert-success mt-3" role="alert">
  <p><i class="fa-solid fa-globe fa-xl"></i> <strong>Overview</strong></p>
  <hr />

  <p><strong>Questions</strong></p>
  <ul>
    <li>How does the performance of GPU compare with that of CPU?</li>
    <li>How to use Koa to do Machine Learning research?</li>
  </ul>

  <p><strong>Objectives</strong></p>
  <ul>
    <li>Do a basic Deep Learning tutorial on Koa</li>
  </ul>
</div>

<p>This is a basic image classification tutorial from CIFAR-10 dataset using TensorFlow.</p>

<div class="alert alert-info" role="alert">
  <p><i class="fa-solid fa-circle-info fa-xl"></i> <strong>About TensorFlow</strong></p>
  <hr />

  <p>TensorFlow is an open source software used in machine learning particularly for training neural networks.</p>

  <p>We’ll define our model using ‘Keras’- a high level API which acts as an interface between TensorFlow
and Python and makes it easy to build and train models. You can read more about it <a href="https://www.tensorflow.org/#">here</a>.</p>
</div>

<h3 id="the-cifar-10-dataset">The CIFAR-10 dataset</h3>

<p>CIFAR-10 is a common dataset used for machine learning and computer vision research. It is a subset of 80 million tiny image dataset and consists of 60,000 images. The images are labelled with 10 different classes. So each class has 5000 training images and 1000 test images. Each row represents a color image of 32 x 32 pixels with 3 channels (RGB).</p>

<figure>
  
    <img src="/morea/hpc/fig/CIFAR-10.jpg" style="max-width: 50%;" alt="/CIFAR" class="img-fluid mx-auto d-block border" />
  
  <figcaption style="text-align: center">
    <small>
      
    </small>
  </figcaption>
</figure>

<h3 id="basic-workflow-of-machine-learning">Basic workflow of Machine Learning</h3>

<ol>
  <li>Collect the data</li>
  <li>Pre-process the data</li>
  <li>Define a model</li>
  <li>Train the model</li>
  <li>Evaluate/test the model</li>
  <li>Improve your model</li>
</ol>

<h3 id="activity-work-with-cifar-10-dataset">Activity: Work with CIFAR-10 dataset</h3>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: Import dataset, check configuration</strong></p>
  <hr />

  <p>To start, import all the relevant libraries:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">import</span> <span class="nn">h5py</span>

<span class="kn">import</span> <span class="nn">keras</span>
<span class="kn">from</span> <span class="nn">keras.datasets</span> <span class="kn">import</span> <span class="n">cifar10</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">MaxPooling2D</span><span class="p">,</span> <span class="n">Input</span><span class="p">,</span> <span class="n">InputLayer</span><span class="p">,</span> <span class="n">Dropout</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">to_categorical</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</code></pre></div>  </div>

  <p>Next, check to see if you’re using the GPU:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tf</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">list_physical_devices</span><span class="p">(</span><span class="s">'GPU'</span><span class="p">)</span>
</code></pre></div>  </div>

  <p>Now, how would you check to see if you’re using the CPU rather than the GPU?</p>

  <details>
  <summary>Solution</summary>

<pre>
tf.config.list_physical_devices('CPU')
</pre>

</details>
</div>

<div class="alert alert-info" role="alert">
  <p><i class="fa-solid fa-circle-info fa-xl"></i> <strong>Is GPU necessary for machine learning?</strong></p>
  <hr />

  <p>No, machine learning algorithms can be deployed using CPU or GPU, depending on the applications. They both have their distinct properties and which one would be best for your application depends on factors like: speed, power usage and cost.</p>

  <p>CPUs are more general purposed processors, are cheaper and provide a gateway for data to travel from source to GPU cores.</p>

  <p>But GPU have an advantage to do parallel computing when dealing with large datasets, complex neural network models. The difference between the two lies in basic features of a processor i.e. cache, clock speed, power consumption, bandwidth and number
of cores.</p>

  <p>Read more that <a href="https://thinkml.ai/cpu-vs-gpu-in-machine-learning-algorithms-which-is-better/#">here</a>.</p>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: Load the data and analyze its shape</strong></p>
  <hr />

  <ol>
    <li>Load the CIFAR-10 data into training and validation datasets</li>
    <li>Print the size of training dataset, showing how many images (‘X’) and labels (‘y’) it contains</li>
    <li>Print the size of validation datasets, showing how many images (‘X’) and labels (‘y’) it contains</li>
    <li>Calculate and print the number of unique categories (‘classes’) in training data</li>
  </ol>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">)</span> <span class="o">=</span> <span class="n">cifar10</span><span class="p">.</span><span class="n">load_data</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Train: X=%s, y=%s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_train</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y_train</span><span class="p">.</span><span class="n">shape</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Test: X=%s, y=%s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_valid</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">.</span><span class="n">shape</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'number of classes= %s'</span> <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_train</span><span class="p">.</span><span class="n">flatten</span><span class="p">())))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">x_train</span><span class="p">))</span>
</code></pre></div>  </div>

  <details>
  <summary>Solution</summary>

<pre>
Downloading data from https://www.cs.toronto.edu/~kriz/cifar-10-python.tar.gz
170498071/170498071 [==============================] - 7s 0us/step
Train: X=(50000, 32, 32, 3), y=(50000, 1)
Test: X=(10000, 32, 32, 3), y=(10000, 1)
number of classes= 10
&lt;class 'numpy.ndarray'&gt;

"Train: X=(50000, 32, 32, 3), y=(50000, 1)" shows that in the training dataset:
- There are 50000 data points or "images"
- Each image has  32 width in pixels, 32 length in pixels, 3 color channels (RGB)
- 50000 rows each containing a single label or "class"
- The number of unique classes is 10

We can confirm this from the description of the CIFAR-10 dataset from earlier!
</pre>

</details>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: Print and display one data point</strong></p>
  <hr />

  <p>First, let’s print out the first data point’s values in the training dataset to see what it looks like:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Data Point </span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s">:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Image Data:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">x_train</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Label:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> 
</code></pre></div>  </div>
  <details>
  <summary>Solution</summary>
<pre>
Data Point 1:
Image Data:
[[[ 59  62  63]
  [ 43  46  45]
  [ 50  48  43]
  ...
  [158 132 108]
  [152 125 102]
  [148 124 103]]

 [[ 16  20  20]
  [  0   0   0]
  [ 18   8   0]
  ...
  [123  88  55]
  [119  83  50]
  [122  87  57]]

 [[ 25  24  21]
  [ 16   7   0]
  [ 49  27   8]
  ...
  [118  84  50]
  [120  84  50]
  [109  73  42]]

 ...

 [[208 170  96]
  [201 153  34]
  [198 161  26]
  ...
  [160 133  70]
  [ 56  31   7]
  [ 53  34  20]]

 [[180 139  96]
  [173 123  42]
  [186 144  30]
  ...
  [184 148  94]
  [ 97  62  34]
  [ 83  53  34]]

 [[177 144 116]
  [168 129  94]
  [179 142  87]
  ...
  [216 184 140]
  [151 118  84]
  [123  92  72]]]
Label:
[6]
</pre>
</details>

  <p>Then we can print the image from that data point, which should be an image with the associated label:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x_train</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s">"Label: </span><span class="si">{</span><span class="n">y_train</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>  </div>

  <details>
  <summary>Solution</summary>
<figure>
  
    <img src="/morea/hpc/fig/first_datapoint_example.png" style="max-width: 100%;" alt="" class="img-fluid mx-auto d-block border" />
  
  <figcaption style="text-align: center">
    <small>
      
    </small>
  </figcaption>
</figure>

</details>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Plot some examples</strong></p>
  <hr />

  <p>First, specify classes from the CIFAR-10 dataset:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nb_classes</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">'airplane'</span><span class="p">,</span> <span class="s">'automobile'</span><span class="p">,</span> <span class="s">'bird'</span><span class="p">,</span> <span class="s">'cat'</span><span class="p">,</span> <span class="s">'deer'</span><span class="p">,</span> <span class="s">'dog'</span><span class="p">,</span> <span class="s">'frog'</span><span class="p">,</span> <span class="s">'horse'</span><span class="p">,</span> <span class="s">'ship'</span><span class="p">,</span> <span class="s">'truck'</span><span class="p">]</span>
</code></pre></div>  </div>

  <p>Then plot some samples:</p>
  <ol>
    <li>Create a new figure to plot with a size of 8x8 inches</li>
    <li>Initiate a loop that will repeat 14 times, <code class="language-plaintext highlighter-rouge">(2*7)</code></li>
    <li>Define a subplot within the grid, positioning it in a 2x7 grid layout, increasing <code class="language-plaintext highlighter-rouge">i</code> for each iteration</li>
    <li>Display image at <code class="language-plaintext highlighter-rouge">x_train[i]</code> in the subplot</li>
    <li>Assign <code class="language-plaintext highlighter-rouge">class_index</code> the category from the label <code class="language-plaintext highlighter-rouge">y_train[i]</code> after converting it to a one-hot encoded format</li>
    <li>Set the title of the current subplot to the class name determined from <code class="language-plaintext highlighter-rouge">class_index</code> with a font size of 9</li>
  </ol>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> 
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">7</span><span class="p">):</span>
    <span class="c1"># define subplot
</span>    <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x_train</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">class_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="n">class_names</span><span class="p">[</span><span class="n">class_index</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
</code></pre></div>  </div>

  <details>
  <summary>Solution</summary>
<figure>
  
    <img src="/morea/hpc/fig/plots.png" style="max-width: 100%;" alt="" class="img-fluid mx-auto d-block border" />
  
  <figcaption style="text-align: center">
    <small>
      
    </small>
  </figcaption>
</figure>

</details>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Check TensorFlow version</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tf</span><span class="p">.</span><span class="n">__version__</span>
</code></pre></div>  </div>

  <details>
  <summary>Solution</summary>
For what we are currently using it should output:

'2.10.0'

</details>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: Convert data to HDF5 format</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">h5py</span><span class="p">.</span><span class="n">File</span><span class="p">(</span><span class="s">'dataset_cifar10.hdf5'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
    <span class="n">dset_x_train</span> <span class="o">=</span> <span class="n">hf</span><span class="p">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s">'x_train'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">x_train</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s">'gzip'</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">dset_y_train</span> <span class="o">=</span> <span class="n">hf</span><span class="p">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s">'y_train'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s">'gzip'</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">dset_x_test</span> <span class="o">=</span> <span class="n">hf</span><span class="p">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s">'x_valid'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">x_valid</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s">'gzip'</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">dset_y_test</span> <span class="o">=</span> <span class="n">hf</span><span class="p">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s">'y_valid'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s">'gzip'</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div>  </div>
</div>

<div class="alert alert-info" role="alert">
  <p><i class="fa-solid fa-circle-info fa-xl"></i> <strong>What is an HDF5 file?</strong></p>
  <hr />

  <p>HDF5 file format is a binary data format which is mainly used to store large, heterogenous files. It provides fast, parallel I/O processing.</p>

  <p>You can learn more about it <a href="https://www.hdfgroup.org/solutions/hdf5/#">here</a> and <a href="https://www.christopherlovell.co.uk/blog/2016/04/27/h5py-intro.html#">here</a>.</p>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: Define the model</strong></p>
  <hr />

  <p>Here, we are creating a sequential model and adding a series of different layers such as convolutional layers and maxpooling layers sequentially to define the structure of this neural network and then outputting it’s summary</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">InputLayer</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span>

<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>

<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'softmax'</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>  </div>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: Define the data generator</strong></p>
  <hr />

  <p>Define a data generator python class that prepares batches of data for training or testing deep learning models which allows for efficient handling of large datasets and data augmentation</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DataGenerator</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">Sequence</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">PATH_TO_FILE</span> <span class="o">=</span> <span class="n">filename</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="p">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">PATH_TO_FILE</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>         
        <span class="bp">self</span><span class="p">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">test</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">on_epoch_end</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">hf</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">indices</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="p">.</span><span class="n">batch_size</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="n">idx</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">test</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">hf</span><span class="p">[</span><span class="s">'x_valid'</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">,</span> <span class="p">...]</span>
            <span class="n">batch_x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">hf</span><span class="p">[</span><span class="s">'y_valid'</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
            <span class="n">batch_y</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">hf</span><span class="p">[</span><span class="s">'x_train'</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">,</span> <span class="p">...]</span>
            <span class="n">batch_x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">hf</span><span class="p">[</span><span class="s">'y_train'</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
            <span class="n">batch_y</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span>

    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">test</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">hf</span><span class="p">[</span><span class="s">'x_valid'</span><span class="p">][:].</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">hf</span><span class="p">[</span><span class="s">'x_train'</span><span class="p">][:].</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">indices</span><span class="p">)</span>
</code></pre></div>  </div>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: Generate batches of data for training and validation dataset</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">filename</span> <span class="o">=</span> <span class="s">"dataset_cifar10.hdf5"</span>
<span class="n">batchsize</span>  <span class="o">=</span> <span class="mi">250</span> 
<span class="n">data_train</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batchsize</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">data_valid</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batchsize</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div>  </div>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: Define optimizer for the model</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s">'adam'</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s">'categorical_crossentropy'</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>
</code></pre></div>  </div>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: First, let’s train the model using CPU</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="n">device</span><span class="p">(</span><span class="s">'/device:CPU:0'</span><span class="p">):</span>
    <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_train</span><span class="p">,</span><span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="n">data_valid</span><span class="p">)</span>
</code></pre></div>  </div>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: Now, let’s compare GPU to CPU performance.</strong></p>
  <hr />

  <p>First, let’s get the CPU performance data.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">clone_model</span>
<span class="n">new_model</span> <span class="o">=</span> <span class="n">clone_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">new_model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s">'categorical_crossentropy'</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>  
</code></pre></div>  </div>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: Train the new model with GPU</strong></p>
  <hr />

  <p>Can you do this yourself?</p>

  <details>
  <summary>Solution</summary>

<pre>

with tf.device('/device:GPU:0'):
  new_history = new_model.fit(data_train,epochs=10, verbose=1, validation_data=data_valid)

</pre>

</details>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: Plot the losses and accuracy for training and validation set</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plotting the losses and accuracy for training and validation set using CPU
</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'loss'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'train_loss'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_loss'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="s">'Loss'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">grid</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'train_acc'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_accuracy'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'val_acc'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="s">'Accuracy'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">grid</span><span class="p">()</span>
</code></pre></div>  </div>

  <details>
  <summary>Solution</summary>
<figure>
  
    <img src="/morea/hpc/fig/graphs_new.png" style="max-width: 100%;" alt="" class="img-fluid mx-auto d-block border" />
  
  <figcaption style="text-align: center">
    <small>
      
    </small>
  </figcaption>
</figure>

</details>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: Evaluate the model and make predictions</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># evaluate the model
</span><span class="n">x</span> <span class="o">=</span> <span class="n">x_valid</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Test cross-entropy loss: %0.5f'</span> <span class="o">%</span> <span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Test accuracy: %0.2f'</span> <span class="o">%</span> <span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>  </div>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># make predictions on the model
</span><span class="n">y_pred</span><span class="o">=</span><span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> 
<span class="n">y_pred_classes</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>  </div>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: Plot the predictions</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> 
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">):</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reshape</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">index1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">"y: %s</span><span class="se">\n</span><span class="s">p: %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">class_names</span><span class="p">[</span><span class="n">index1</span><span class="p">],</span> <span class="n">class_names</span><span class="p">[</span><span class="n">y_pred_classes</span><span class="p">[</span><span class="n">i</span><span class="p">]]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
</code></pre></div>  </div>

  <details>
  <summary>Solution</summary>
<figure>
  
    <img src="/morea/hpc/fig/cpu_plot.png" style="max-width: 100%;" alt="" class="img-fluid mx-auto d-block border" />
  
  <figcaption style="text-align: center">
    <small>
      
    </small>
  </figcaption>
</figure>

</details>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: Plot the losses and accuracy for training and validation set for GPU</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plotting the losses and accuracy for training and validation set using GPU
</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">plot</span><span class="p">(</span><span class="n">new_history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'loss'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'train_loss'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">plot</span><span class="p">(</span><span class="n">new_history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_loss'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="s">'Loss'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">grid</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">plot</span><span class="p">(</span><span class="n">new_history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'train_acc'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">plot</span><span class="p">(</span><span class="n">new_history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_accuracy'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'val_acc'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="s">'Accuracy'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">grid</span><span class="p">()</span>
</code></pre></div>  </div>

  <details>
  <summary>Solution</summary>
<figure>
  
    <img src="/morea/hpc/fig/gpu_graph.png" style="max-width: 100%;" alt="" class="img-fluid mx-auto d-block border" />
  
  <figcaption style="text-align: center">
    <small>
      
    </small>
  </figcaption>
</figure>

</details>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: Evaluate the model and make predictions again</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># evaluate the new_model 
</span><span class="n">x</span> <span class="o">=</span> <span class="n">x_valid</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">new_model</span><span class="p">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Test cross-entropy loss: %0.5f'</span> <span class="o">%</span> <span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Test accuracy: %0.2f'</span> <span class="o">%</span> <span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>  </div>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># make predictions on the new_model
</span><span class="n">y_pred</span><span class="o">=</span><span class="n">new_model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> 
<span class="n">y_pred_classes</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>  </div>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: Plot the predictions again</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> 
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">):</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reshape</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">index1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">"y: %s</span><span class="se">\n</span><span class="s">p: %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">class_names</span><span class="p">[</span><span class="n">index1</span><span class="p">],</span> <span class="n">class_names</span><span class="p">[</span><span class="n">y_pred_classes</span><span class="p">[</span><span class="n">i</span><span class="p">]]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
</code></pre></div>  </div>

  <details>
  <summary>Solution</summary>
<figure>
  
    <img src="/morea/hpc/fig/gpu_plot.png" style="max-width: 100%;" alt="" class="img-fluid mx-auto d-block border" />
  
  <figcaption style="text-align: center">
    <small>
      
    </small>
  </figcaption>
</figure>

</details>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Exercise: Looking at the predictions side by side</strong></p>
  <hr />

  <p>Left: CPU prediction on the model, right: GPU prediction on the new model</p>

  <div style="display: flex; justify-content: space-between;">

  <div style="flex: 1; max-width: 49%;">
    <figure>
  
    <img src="/morea/hpc/fig/cpu_plot.png" style="max-width: 100%;" alt="" class="img-fluid mx-auto d-block border" />
  
  <figcaption style="text-align: center">
    <small>
      
    </small>
  </figcaption>
</figure>

  </div>

  <div style="flex: 1; max-width: 49%;">
    <figure>
  
    <img src="/morea/hpc/fig/gpu_plot.png" style="max-width: 100%;" alt="" class="img-fluid mx-auto d-block border" />
  
  <figcaption style="text-align: center">
    <small>
      
    </small>
  </figcaption>
</figure>

  </div>

</div>

</div>

<div class="alert alert-info" role="alert">
  <p><i class="fa-solid fa-circle-info fa-xl"></i> <strong>Other Machine Learning resources</strong></p>
  <hr />

  <ul>
    <li>You can use <a href="https://colab.research.google.com/#">Google Colab</a> which uses Jupyter notebooks too but on Google server. Here you can get free limited compute resources (even GPU) and upgrade your account (for TPU) if you want more. The code usually runs on Google servers on cloud and is connected to your google account so all your projects will be saved in your Google Drive.</li>
    <li>Microsoft <a href="https://visualstudio.microsoft.com/vs/features/notebooks-at-microsoft/#">Azure notebook</a> is similar to Google Colab with cloud sharing functionality but provides more memory.</li>
    <li>Kaggle</li>
    <li>Amazon Sage Maker</li>
  </ul>

</div>

<div class="alert alert-success" role="alert">
  <p><i class="fa-solid fa-globe fa-xl"></i> <strong>Key Points</strong></p>
  <hr />

  <ul>
    <li>JupyterLab is a more common platform for data science research but there are other IDE (Integrated Development Environment softwares) like PyCharm, Spyder, RMarkdown too.</li>
    <li>Using multiple GPUs won’t improve the performance of your machine learning model. It only helps for a very complex computation or large models.</li>
  </ul>
</div>

<div style="text-align: right; padding-bottom: 10px">
  <hr />
  <button type="button" onclick="window.location='/morea/hpc/experience-hpc-file-systems.html'" class="btn btn-primary">
    <p style="font-size:16px; margin: 0">Staging and File System Choice -&gt;</p>
    <p style="font-size:12px; margin: 0">3:40pm</p>
    </button>
</div>


</div>




<!-- Maybe find a different way?
<script src="/js/scrollIfAnchor.js"></script>
-->

<footer class="footer footer-background" style="padding-top: 1em; padding-bottom: 1em">
  <div class="container text-center">
    
    

    
    <p style="margin: 0">Powered by the <a class="footer-link" href="https://morea-framework.github.io/">Morea Framework</a> (Theme: spacelab)<br>
      Last update on: <span>2023-12-01 13:58:35 -1000</span></p>

    <p style="margin: 0">
      
      18 modules
      
      | 17 outcomes
      
      
      | 55 readings
      
      
      | 100 experiences
      
      
      | 15 assessments
      
    </p>
  </div>
</footer>


<!-- Load Bootstrap JavaScript components -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>


<script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-MML-AM_CHTML">
</script>


<!-- Add anchors to pages. -->
<script>anchors.add();</script>


</body>
</html>
